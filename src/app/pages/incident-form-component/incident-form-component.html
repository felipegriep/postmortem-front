<div class="incident-form-wrapper">
  <form #incidentForm="ngForm" (ngSubmit)="onSubmit()" class="incident-form">
    <div class="form-panel w-full p-4 md:p-8 dark:bg-gray-800">
    <header class="mb-8 border-b pb-4 dark:border-gray-600">
      <h1 class="form-title text-gray-800 dark:text-gray-100">
        {{ isEditMode ? 'Editar Incidente #' + incident.id : 'Registrar Novo Incidente' }}
      </h1>
      <p class="form-subtitle text-gray-500 dark:text-gray-400 mt-1">
        Preencha os detalhes do incidente abaixo.
      </p>
    </header>
      <div class="grid gap-6 md:grid-cols-2 form-grid">
        <div class="md:col-span-2">
            <mat-form-field
              appearance="fill"
              floatLabel="always"
              class="w-full"
              [ngClass]="{ 'has-error': title.invalid && (title.dirty || title.touched) }"
            >
              <mat-label>Título do Incidente</mat-label>
              <input
                matInput
                id="title"
                name="title"
                #title="ngModel"
                [(ngModel)]="incident.title"
                placeholder="Ex: Indisponibilidade da API de Pagamentos"
                required
              />
              <mat-error *ngIf="title.invalid && (title.dirty || title.touched)">
                O título é obrigatório.
              </mat-error>
            </mat-form-field>
          </div>

          <div class="md:col-span-2">
            <mat-form-field
              appearance="fill"
              floatLabel="always"
              class="w-full"
              [ngClass]="{ 'has-error': service.invalid && (service.dirty || service.touched) }"
            >
              <mat-label>Serviço Afetado</mat-label>
              <input
                matInput
                id="service"
                name="service"
                #service="ngModel"
                [(ngModel)]="incident.service"
                placeholder="Ex: billing, checkout, auth"
                required
              />
              <mat-error *ngIf="service.invalid && (service.dirty || service.touched)">
                O serviço é obrigatório.
              </mat-error>
            </mat-form-field>
          </div>

          <div>
            <mat-form-field
              appearance="fill"
              floatLabel="always"
              class="w-full"
              [ngClass]="{ 'has-error': severity.invalid && (severity.dirty || severity.touched) }"
            >
              <mat-label>Severidade</mat-label>
              <mat-select id="severity" name="severity" #severity="ngModel" [(ngModel)]="incident.severity" required>
                <mat-option *ngFor="let option of severityOptions" [value]="option.value">
                  {{ option.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="severity.invalid && (severity.dirty || severity.touched)">
                A severidade é obrigatória.
              </mat-error>
            </mat-form-field>
          </div>

          <div>
            <mat-form-field
              appearance="fill"
              floatLabel="always"
              class="w-full"
              [ngClass]="{ 'has-error': status.invalid && (status.dirty || status.touched) }"
            >
              <mat-label>Status</mat-label>
              <mat-select id="status" name="status" #status="ngModel" [(ngModel)]="incident.status" required>
                <mat-option *ngFor="let option of statusOptions" [value]="option.value">
                  {{ option.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="status.invalid && (status.dirty || status.touched)">
                O status é obrigatório.
              </mat-error>
            </mat-form-field>
          </div>

          <div>
            <mat-form-field
              appearance="fill"
              floatLabel="always"
              class="w-full"
              [ngClass]="{
                'has-error':
                  startedAt.invalid && (startedAt.dirty || startedAt.touched) || startedAt.errors?.['parse']
              }"
            >
              <mat-label>Início do Incidente</mat-label>
              <input
                matInput
                #startedAtInput
                id="startedAt"
                name="startedAt"
                #startedAt="ngModel"
                [(ngModel)]="incident.startedAt"
                required
                [placeholder]="datePlaceholder"
              />
              <button
                mat-icon-button
                matSuffix
                type="button"
                aria-label="Abrir calendário"
                (click)="openCalendar('started')"
              >
                <fa-icon [icon]="calendarDay" aria-hidden="true"></fa-icon>
              </button>
              <mat-error *ngIf="startedAt.errors?.['required'] && (startedAt.dirty || startedAt.touched)">
                A data de início é obrigatória.
              </mat-error>
              <mat-error *ngIf="startedAt.errors?.['parse']">
                Formato inválido. Use DD/MM/YYYY HH:mm:ss
              </mat-error>
            </mat-form-field>
          </div>

          <div>
            <mat-form-field
              appearance="fill"
              floatLabel="always"
              class="w-full"
              [ngClass]="{
                'has-error':
                  endedAt.invalid && (endedAt.dirty || endedAt.touched) ||
                  endedAt.errors?.['parse'] ||
                  endedAt.errors?.['range']
              }"
            >
              <mat-label>Fim do Incidente</mat-label>
              <input
                matInput
                #endedAtInput
                id="endedAt"
                name="endedAt"
                #endedAt="ngModel"
                [(ngModel)]="incident.endedAt"
                [placeholder]="datePlaceholder"
              />
              <button
                mat-icon-button
                matSuffix
                type="button"
                aria-label="Abrir calendário"
                (click)="openCalendar('ended')"
              >
                <fa-icon [icon]="calendarDay" aria-hidden="true"></fa-icon>
              </button>
              <mat-error *ngIf="endedAt.errors?.['parse']">
                Formato inválido. Use DD/MM/YYYY HH:mm:ss
              </mat-error>
              <mat-error *ngIf="endedAt.errors?.['range']">
                A data de término não pode ser anterior à data de início.
              </mat-error>
            </mat-form-field>
          </div>

          <div class="md:col-span-2">
            <mat-form-field
              appearance="fill"
              floatLabel="always"
              class="w-full"
              [ngClass]="{
                'has-error': impactShortModel.invalid && (impactShortModel.dirty || impactShortModel.touched)
              }"
            >
              <mat-label>Breve Resumo do Impacto</mat-label>
              <textarea
                matInput
                id="impactShort"
                name="impactShort"
                #impactShortModel="ngModel"
                class="impact-textarea"
                [(ngModel)]="incident.impactShort"
                maxlength="4000"
                placeholder="Descreva o impacto de forma concisa. O que foi afetado, quantos clientes, por quanto tempo?"
                cdkTextareaAutosize
                cdkAutosizeMinRows="4"
                cdkAutosizeMaxRows="8"
              ></textarea>
              <mat-hint align="end" class="char-counter">
                {{ impactShortLength }}/4000
              </mat-hint>
              <mat-error *ngIf="impactShortModel.errors?.['maxlength']">
                Limite máximo de 4000 caracteres.
              </mat-error>
            </mat-form-field>
          </div>
      </div>
    </div>
    <footer class="form-footer">
      <div class="form-footer__status">
        <span class="form-footer__label">Última atualização</span>
        <span class="form-footer__value">{{ lastUpdatedDisplay || 'Sem registro' }}</span>
      </div>
      <div class="form-footer__actions">
        <button mat-stroked-button color="accent" type="button" class="cancel-button" (click)="onCancel()">
          Cancelar
        </button>
        <button
          mat-flat-button
          color="primary"
          class="incident-primary-button"
          [disabled]="incidentForm?.invalid || !isDateRangeValid()"
          type="submit"
        >
          {{ isEditMode ? 'Salvar Alterações' : 'Criar Incidente' }}
        </button>
      </div>
    </footer>
  </form>
</div>

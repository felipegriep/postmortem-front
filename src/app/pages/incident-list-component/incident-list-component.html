<div class="container mx-auto p-4 md:p-8 max-w-5xl">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 md:p-8">
        <header class="mb-6 flex items-center justify-between">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Incidentes</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Liste, filtre e gerencie os incidentes.</p>
            </div>
            <button (click)="createNewIncident()" class="btn-primary" type="button">
                Novo Incidente
            </button>
        </header>

        <!-- Filtros -->
        <section class="mb-6">
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Serviço</label>
                    <input [(ngModel)]="filters.service" (ngModelChange)="onServiceChange($event)" class="form-input w-full"
                            name="filterService" type="text" placeholder="Digite o serviço (ex: billing)">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Severidade</label>
                    <select (ngModelChange)="onSeverityChange($event)" [(ngModel)]="filters.severity" class="form-input w-full"
                            name="filterSeverity">
                        <option value="">Todas</option>
                        <option *ngFor="let s of availableSeverities" [value]="s">{{ s }}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Status</label>
                    <select (ngModelChange)="onStatusChange($event)" [(ngModel)]="filters.status" class="form-input w-full"
                            name="filterStatus">
                        <option value="">Todos</option>
                        <option *ngFor="let s of availableStatus" [value]="s">{{ s }}</option>
                    </select>
                </div>
            </div>
            <div class="mt-3 text-right">
                <button (click)="resetFilters()" class="text-sm text-gray-600 hover:text-gray-800 underline"
                        type="button">Limpar filtros
                </button>
            </div>
        </section>

        <!-- Lista de Incidentes -->
        <section>
            <div *ngIf="filteredIncidents.length === 0" class="text-center text-gray-500 dark:text-gray-400 py-8">
                Nenhum incidente encontrado.
            </div>

            <!-- Angular Material Table -->
            <div *ngIf="filteredIncidents.length > 0" class="mb-4">
                <table mat-table [dataSource]="dataSource" matSort class="min-w-full">

                    <!-- ID Column -->
                    <ng-container matColumnDef="id">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-left">#</th>
                        <td mat-cell *matCellDef="let row">{{ row.id }}</td>
                    </ng-container>

                    <!-- Title Column -->
                    <ng-container matColumnDef="title">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-left">Título</th>
                        <td mat-cell *matCellDef="let row">{{ row.title }}</td>
                    </ng-container>

                    <!-- Service Column -->
                    <ng-container matColumnDef="service">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Serviço</th>
                        <td mat-cell *matCellDef="let row">{{ row.service }}</td>
                    </ng-container>

                    <!-- Severity Column -->
                    <ng-container matColumnDef="severity">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Severidade</th>
                        <td mat-cell *matCellDef="let row"><span [ngClass]="getSeverityClass(row.severity)" class="px-2 py-1 rounded text-xs font-semibold">{{ row.severity }}</span></td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                        <td mat-cell *matCellDef="let row"><span [ngClass]="getStatusClass(row.status)" class="px-2 py-1 rounded text-xs font-semibold">{{ row.status }}</span></td>
                    </ng-container>

                    <!-- Started At Column -->
                    <ng-container matColumnDef="startedAt">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Início</th>
                        <td mat-cell *matCellDef="let row">{{ row.startedAt | date: 'short' }}</td>
                    </ng-container>

                    <!-- Ended At Column -->
                    <ng-container matColumnDef="endedAt">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fim</th>
                        <td mat-cell *matCellDef="let row">{{ row.endedAt ? (row.endedAt | date: 'short') : '-' }}</td>
                    </ng-container>

                    <!-- MTTR Column -->
                    <ng-container matColumnDef="mttr">
                        <th mat-header-cell *matHeaderCellDef>MTTR</th>
                        <td mat-cell *matCellDef="let row"> - </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let row" class="text-right">
                            <button type="button" aria-label="Editar incidente" class="btn-primary btn-icon" (click)="editIncident(+row.id)">
                                <!-- inline pencil SVG (no external packages) - color uses currentColor so it inherits the btn text color (white) -->
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" aria-hidden="true">
                                    <path d="M17.414 2.586a2 2 0 0 0-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 0 0 0-2.828z" />
                                    <path d="M2 15a1 1 0 011-1h3.586L15.293 5.293l-1.414-1.414L5.172 12.586V16H2v-1z" />
                                </svg>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell text-center text-gray-500 dark:text-gray-400 py-8" [attr.colspan]="displayedColumns.length">Nenhum incidente encontrado.</td>
                    </tr>
                </table>

                <div class="mt-4">
                    <mat-paginator [pageSizeOptions]="[5,10,20]"></mat-paginator>
                </div>
            </div>

        </section>
    </div>
</div>

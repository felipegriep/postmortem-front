<mat-drawer-container class="action-drawer-container">
    <mat-drawer-content class="action-drawer-content dark:bg-gray-800">
        <div class="w-full action-tab-wrapper">
            <div class="mt-6">
                <div class="action-header-card bg-slate-900 dark:bg-gray-800">
                    <header class="action-header">
                        <div class="flex items-center justify-between pb-4 border-b dark:border-gray-600">
                            <div>
                                <h2 class="action-title text-white">
                                    Ações do incidente
                                </h2>
                                <p class="action-subtitle text-white/80">
                                    Gerencie atividades corretivas e preventivas.
                                </p>
                            </div>
                            <button
                                mat-flat-button
                                color="primary"
                                class="action-new-button"
                                type="button"
                                (click)="onCreateAction()"
                                [disabled]="isLoading"
                            >
                                <fa-icon [icon]="plusIcon" aria-hidden="true"></fa-icon>
                                <span>Nova Ação</span>
                            </button>
                        </div>
                        <div class="action-blameless-note blameless-banner" role="note">
                            <fa-icon class="blameless-banner__icon" [icon]="infoIcon" aria-hidden="true"></fa-icon>
                            <div class="action-blameless-copy">
                                <p class="blameless-banner__title">Cultura sem culpabilização</p>
                                <p class="blameless-banner__desc">
                                    Planeje melhorias sistêmicas e de processo. Este espaço é para aprender, não para atribuir culpa.
                                </p>
                            </div>
                        </div>
                    </header>
                </div>

                <section class="action-filter-card bg-slate-900 text-white dark:bg-gray-800">
                    <form class="action-filter-grid" [formGroup]="filterForm">
                        <mat-form-field appearance="fill" class="filter-field">
                            <mat-label>Tipo</mat-label>
                            <mat-select formControlName="type">
                                <mat-option value="">Todos</mat-option>
                                <mat-option *ngFor="let type of typeOptions" [value]="type">
                                    {{ getTypeLabel(type) }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="fill" class="filter-field">
                            <mat-label>Status</mat-label>
                            <mat-select formControlName="status">
                                <mat-option value="">Todos</mat-option>
                                <mat-option *ngFor="let status of statusOptions" [value]="status">
                                    {{ getStatusLabel(status) }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="fill" class="filter-field">
                            <mat-label>Buscar</mat-label>
                            <input matInput formControlName="query" placeholder="Descrição ou link" />
                            <button
                                mat-icon-button
                                matSuffix
                                type="button"
                                *ngIf="filterForm.value.query"
                                (click)="filterForm.get('query')?.setValue('')"
                                aria-label="Limpar busca"
                            >
                                <mat-icon>close</mat-icon>
                            </button>
                        </mat-form-field>

                        <mat-checkbox color="primary" formControlName="overdue" class="filter-checkbox">
                            Somente atrasadas
                        </mat-checkbox>
                    </form>
                </section>

                <section class="action-content-wrapper" *ngIf="!isLoading && actionItems.length">
                    <div class="action-content">
                        <mat-card class="action-card" *ngFor="let item of actionItems">
                            <div class="action-card__header">
                                <div>
                                    <span
                                        class="action-card__badge"
                                        [ngClass]="'action-card__badge--' + getStatusBadge(item)"
                                    >
                                        {{ getStatusLabel(getStatusBadge(item)) }}
                                    </span>
                                    <span class="action-card__type" [ngClass]="'action-card__type--' + item.type">
                                        {{ getTypeLabel(item.type) }}
                                    </span>
                                </div>
                                <div class="action-card__actions">
                                    <button
                                        type="button"
                                        class="btn-icon edit-icon"
                                        matTooltip="Editar"
                                        matTooltipPosition="above"
                                        (click)="onEditAction(item)"
                                    >
                                        <fa-icon [icon]="editIcon" aria-hidden="true"></fa-icon>
                                    </button>
                                    <button
                                        type="button"
                                        class="btn-icon delete-icon"
                                        matTooltip="Excluir"
                                        matTooltipPosition="above"
                                        (click)="onDeleteAction(item)"
                                    >
                                        <fa-icon [icon]="deleteIcon" aria-hidden="true"></fa-icon>
                                    </button>
                                </div>
                            </div>

                            <div class="action-card__body">
                            <h3 class="action-card__title">
                                {{ truncatedDescription(item.description, 120) }}
                            </h3>
                                <div class="action-card__meta">
                                    <span class="meta-entry">
                                        <fa-icon [icon]="dueIcon" aria-hidden="true"></fa-icon>
                                        <strong>Vence em</strong>
                                        {{ formatDateToDisplayFn(item.dueDate) || 'Não informado' }}
                                    </span>
                                    <span class="meta-entry">
                                        <fa-icon [icon]="ownerIcon" aria-hidden="true"></fa-icon>
                                        <strong>Responsável</strong>
                                        {{ item.owner?.name || 'Não informado' }}
                                    </span>
                                    <span class="meta-entry" *ngIf="item.evidenceLink; else noEvidence">
                                        <fa-icon [icon]="linkIcon" aria-hidden="true"></fa-icon>
                                        <strong>Evidência</strong>
                                        <a
                                            [href]="item.evidenceLink"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                        >
                                            {{ item.evidenceLink }}
                                        </a>
                                    </span>
                                    <ng-template #noEvidence>
                                        <span class="meta-entry">
                                            <fa-icon [icon]="linkOffIcon" aria-hidden="true"></fa-icon>
                                            <strong>Evidência</strong>
                                            Não informada
                                        </span>
                                    </ng-template>
                                </div>
                            </div>

                            <div class="action-card__footer" *ngIf="item.sla">
                                <span><strong>Criada em</strong> {{ item.createdAt | date: 'dd/MM/yyyy HH:mm' }}</span>
                                <span *ngIf="item.updatedAt">
                                    <strong>Atualizada em</strong> {{ item.updatedAt | date: 'dd/MM/yyyy HH:mm' }}
                                </span>
                            </div>
                        </mat-card>
                    </div>
                </section>

                <mat-card class="action-empty-card" *ngIf="!isLoading && !actionItems.length">
                    <p>Nenhuma ação registrada para este incidente.</p>
                </mat-card>

                <div class="action-loading" *ngIf="isLoading">
                    <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
                </div>

                <div class="mt-4 w-full">
                    <mat-paginator
                        [length]="totalItems"
                        [pageIndex]="pageIndex"
                        [pageSize]="pageSize"
                        [pageSizeOptions]="pageSizeOptions"
                        (page)="onPageChange($event)"
                        showFirstLastButtons
                    ></mat-paginator>
                </div>
            </div>
        </div>
    </mat-drawer-content>

    <mat-drawer
        #actionDrawer
        class="action-drawer-panel"
        position="end"
        mode="over"
        [autoFocus]="false"
        (closedStart)="onDrawerClosed()"
    >
        <app-action-item-dialog-component
            [mode]="isDrawerEdit ? 'edit' : 'create'"
            [action]="drawerAction"
            [owners]="owners"
            [incidentStartedAt]="incidentStartedAt"
            [resetToken]="drawerResetToken"
            (cancelled)="onDrawerCancel()"
            (submitted)="onDrawerSubmit($event)"
        ></app-action-item-dialog-component>
    </mat-drawer>
</mat-drawer-container>

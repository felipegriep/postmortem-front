<div class="drawer-wrapper">
    <header class="drawer-header">
        <div class="drawer-header-text">
            <h2 class="drawer-title">{{ mode === 'create' ? 'Nova Ação' : 'Editar Ação' }}</h2>
            <p class="drawer-subtitle">
                Preencha os detalhes da ação. Campos com * são obrigatórios.
            </p>
        </div>

        <button type="button" aria-label="Fechar" (click)="cancel()" class="close-icon">
            <fa-icon [icon]="closeIcon" aria-hidden="true"></fa-icon>
        </button>
    </header>

    <form class="drawer-form" [formGroup]="form" (ngSubmit)="submit()">
        <div class="drawer-body">
            <mat-form-field appearance="fill" class="full-width">
                <mat-label>Tipo</mat-label>
                <mat-select formControlName="type" required>
                    <mat-option *ngFor="let type of typeOptions" [value]="type">
                        {{ getTypeLabel(type) }}
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="form.get('type')?.hasError('required')">Selecione um tipo.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" class="full-width">
                <mat-label>Descrição</mat-label>
                <textarea
                    matInput
                    formControlName="description"
                    required
                    maxlength="4000"
                    cdkTextareaAutosize
                    cdkAutosizeMinRows="3"
                    cdkAutosizeMaxRows="6"
                ></textarea>
                <mat-hint class="description-counter" align="end">
                    {{ form.get('description')?.value?.length || 0 }}/4000
                </mat-hint>
                <mat-error *ngIf="form.get('description')?.hasError('required')">
                    Descreva a ação.
                </mat-error>
            </mat-form-field>

            <ng-container *ngIf="owners.length; else ownerIdFallback">
                <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Responsável</mat-label>
                    <input
                        type="text"
                        matInput
                        formControlName="owner"
                        [matAutocomplete]="ownerAutocomplete"
                        autocomplete="off"
                        required
                    />
                    <mat-autocomplete
                        #ownerAutocomplete="matAutocomplete"
                        [displayWith]="displayOwner"
                        (optionSelected)="onOwnerOptionSelected($event.option.value)"
                    >
                        <mat-option
                            *ngFor="let option of filteredOwners$ | async"
                            [value]="option"
                        >
                            {{ displayOwner(option) }}
                        </mat-option>
                    </mat-autocomplete>
                    <mat-error *ngIf="form.get('owner')?.hasError('required')">
                        Selecione o responsável.
                    </mat-error>
                </mat-form-field>
            </ng-container>
            <ng-template #ownerIdFallback>
                <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Responsável</mat-label>
                    <input matInput type="number" formControlName="ownerId" required />
                    <mat-error *ngIf="form.get('ownerId')?.hasError('required')">
                        Informe o responsável.
                    </mat-error>
                </mat-form-field>
            </ng-template>

            <mat-form-field appearance="fill" class="full-width">
                <mat-label>Data de Vencimento</mat-label>
                <input
                    #dueDateInput
                    matInput
                    formControlName="dueDate"
                    [placeholder]="datePlaceholder"
                    (focus)="openCalendar()"
                    autocomplete="off"
                />
                <button mat-icon-button matSuffix type="button" (click)="openCalendar()">
                    <fa-icon [icon]="calendarDay" aria-hidden="true"></fa-icon>
                </button>
                <mat-error *ngIf="form.get('dueDate')?.hasError('required')">
                    Informe uma data de vencimento.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" class="full-width">
                <mat-label>Status</mat-label>
                <mat-select formControlName="status" required>
                    <mat-option *ngFor="let status of statusOptions" [value]="status">
                        {{ getStatusLabel(status) }}
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="form.get('status')?.hasError('required')">
                    Informe o status atual.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" class="full-width">
                <mat-label>Link de Evidência (opcional)</mat-label>
                <input matInput formControlName="evidenceLink" />
            </mat-form-field>
        </div>

        <div class="drawer-actions">
            <button type="button" class="btn-secondary drawer-cancel-button" (click)="cancel()">
                Cancelar
            </button>
            <button type="submit" class="btn-primary drawer-primary-button" [disabled]="form.invalid">
                {{ mode === 'create' ? 'Criar Ação' : 'Salvar Alterações' }}
            </button>
        </div>
    </form>
</div>

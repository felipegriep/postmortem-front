<div class="incident-list-wrapper">
    <div class="mt-6">
        <div class="incident-header-card bg-slate-900 dark:bg-gray-800">
            <header class="incident-header flex items-center justify-between">
                <div>
                    <h2 class="incident-title text-white">
                        Incidentes
                    </h2>
                    <p class="incident-subtitle text-white/80">
                        Liste, filtre e gerencie os incidentes.
                    </p>
                </div>
                <button
                    mat-flat-button
                    color="primary"
                    class="incident-new-button"
                    type="button"
                    (click)="createNewIncident()"
                >
                    <fa-icon [icon]="plus" aria-hidden="true"></fa-icon>
                    <span>Novo Incidente</span>
                </button>
            </header>
        </div>

        <section class="incident-filter-card bg-slate-900 text-white dark:bg-gray-800">
            <div class="incident-filter-grid">
                <mat-form-field appearance="fill" class="filter-field">
                    <mat-label>Serviço</mat-label>
                    <input
                        matInput
                        [(ngModel)]="filters.service"
                        (ngModelChange)="onServiceChange($event)"
                        name="filterService"
                        type="text"
                        placeholder="Digite o serviço"
                    />
                    <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        *ngIf="filters.service"
                        (click)="filters.service = ''; onServiceChange('')"
                        aria-label="Limpar busca"
                    >
                        <mat-icon>close</mat-icon>
                    </button>
                </mat-form-field>

                <mat-form-field appearance="fill" class="filter-field">
                    <mat-label>Severidade</mat-label>
                    <mat-select
                        (ngModelChange)="onSeverityChange($event)"
                        [(ngModel)]="filters.severity"
                        name="filterSeverity"
                    >
                        <mat-option value="">Todas</mat-option>
                        <mat-option *ngFor="let option of severityOptions" [value]="option.value">
                            {{ option.label }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="fill" class="filter-field">
                    <mat-label>Status</mat-label>
                    <mat-select
                        (ngModelChange)="onStatusChange($event)"
                        [(ngModel)]="filters.status"
                        name="filterStatus"
                    >
                        <mat-option value="">Todos</mat-option>
                        <mat-option *ngFor="let option of statusOptions" [value]="option.value">
                            {{ option.label }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="fill" class="filter-field">
                    <mat-label>Ordenar por</mat-label>
                    <mat-select
                        [(ngModel)]="selectedSort"
                        (ngModelChange)="onSortChange($event)"
                        name="sortField"
                    >
                        <mat-option *ngFor="let option of sortOptions" [value]="option.value">
                            {{ option.label }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <button
                    type="button"
                    (click)="resetFilters()"
                    mat-stroked-button
                    class="filter-clear-button"
                >
                    Limpar filtros
                </button>
            </div>
        </section>

        <section class="incident-content-wrapper" *ngIf="incidents.length">
            <div class="incident-content">
                <mat-card class="incident-card" *ngFor="let incident of incidents">
                    <div class="incident-card__header">
                        <div>
                            <span class="incident-card__id">#{{ incident.id }}</span>
                            <span
                                class="incident-card__badge"
                                [ngClass]="'incident-card__badge--' + incident.severity"
                            >
                                {{ getSeverityLabel(incident.severity) }}
                            </span>
                            <span class="incident-card__status" [ngClass]="'incident-card__status--' + incident.status">
                                {{ getStatusLabel(incident.status) }}
                            </span>
                        </div>
                        <div class="incident-card__actions">
                            <button
                                type="button"
                                class="btn-icon edit-icon"
                                matTooltip="Editar"
                                matTooltipPosition="above"
                                (click)="editIncident(+incident.id)"
                            >
                                <fa-icon [icon]="pencil" aria-hidden="true"></fa-icon>
                            </button>
                        </div>
                    </div>

                    <div class="incident-card__body">
                        <h3 class="incident-card__title">
                            {{ incident.title || 'Sem título' }}
                        </h3>
                        <div class="incident-card__service">
                            <fa-icon [icon]="briefcaseIcon" aria-hidden="true"></fa-icon>
                            <strong>Serviço:</strong>
                            <span>{{ incident.service || 'Não informado' }}</span>
                        </div>
                        <div class="incident-card__meta">
                            <span class="meta-entry">
                                <fa-icon [icon]="clockIcon" aria-hidden="true"></fa-icon>
                                <strong>Início</strong>
                                {{ incident.startedAt | date: dateDisplayFormat }}
                            </span>
                            <span class="meta-entry">
                                <fa-icon [icon]="calendarIcon" aria-hidden="true"></fa-icon>
                                <strong>Fim</strong>
                                {{ incident.endedAt ? (incident.endedAt | date: dateDisplayFormat) : 'Em andamento' }}
                            </span>
                            <span class="meta-entry">
                                <fa-icon [icon]="stopwatchIcon" aria-hidden="true"></fa-icon>
                                <strong>MTTR</strong>
                                {{ incident.mttrMinutes ? incident.mttrMinutes + ' min' : 'N/A' }}
                            </span>
                            <span class="meta-entry">
                                <fa-icon [icon]="starIcon" aria-hidden="true"></fa-icon>
                                <strong>Score</strong>
                                {{ incident.completenessScore !== undefined && incident.completenessScore !== null ? incident.completenessScore : 'N/A' }}
                            </span>
                        </div>
                    </div>
                </mat-card>
            </div>
        </section>

        <mat-card class="incident-empty-card" *ngIf="!incidents.length">
            <p>Nenhum incidente encontrado.</p>
        </mat-card>

        <div class="mt-4 w-full">
            <mat-paginator
                [length]="totalItems"
                [pageIndex]="pageIndex"
                [pageSize]="pageSize"
                [pageSizeOptions]="pageSizeOptions"
                (page)="onPageChange($event)"
                showFirstLastButtons
            ></mat-paginator>
        </div>
    </div>
</div>

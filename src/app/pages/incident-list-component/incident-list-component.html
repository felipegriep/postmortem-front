<div class="incident-list-wrapper">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 md:p-8">
        <header class="mb-6 flex items-center justify-between">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Incidentes</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Liste, filtre e gerencie os incidentes.</p>
            </div>
            <button
                mat-flat-button
                color="primary"
                (click)="createNewIncident()"
                type="button"
                class="incident-primary-button"
            >
                Novo Incidente
            </button>
        </header>

        <!-- Filtros -->
        <section class="mb-6">
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <mat-form-field appearance="fill" class="filter-field">
                        <mat-label>Serviço</mat-label>
                        <input
                            matInput
                            [(ngModel)]="filters.service"
                            (ngModelChange)="onServiceChange($event)"
                            name="filterService"
                            type="text"
                            placeholder="Digite o serviço (ex: billing)"
                        />
                    </mat-form-field>
                </div>
                <div>
                    <mat-form-field appearance="fill" class="filter-field">
                        <mat-label>Severidade</mat-label>
                        <mat-select
                            (ngModelChange)="onSeverityChange($event)"
                            [(ngModel)]="filters.severity"
                            name="filterSeverity"
                        >
                            <mat-option value="">Todas</mat-option>
                            <mat-option *ngFor="let s of availableSeverities" [value]="s">{{ s }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div>
                    <mat-form-field appearance="fill" class="filter-field">
                        <mat-label>Status</mat-label>
                        <mat-select
                            (ngModelChange)="onStatusChange($event)"
                            [(ngModel)]="filters.status"
                            name="filterStatus"
                        >
                            <mat-option value="">Todos</mat-option>
                            <mat-option *ngFor="let s of availableStatus" [value]="s">{{ s }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
            <div class="mt-3 text-right">
                <button (click)="resetFilters()" class="text-sm text-gray-600 hover:text-gray-800 underline"
                        type="button">Limpar filtros
                </button>
            </div>
        </section>

        <!-- Lista de Incidentes -->
        <section>
            <div *ngIf="filteredIncidents.length === 0" class="text-center text-gray-500 dark:text-gray-400 py-8">
                Nenhum incidente encontrado.
            </div>

            <!-- Angular Material Table -->
            <div *ngIf="filteredIncidents.length > 0" class="mb-4">
                <table mat-table [dataSource]="dataSource" matSort class="min-w-full">

                    <!-- ID Column -->
                    <ng-container matColumnDef="id">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-left">#</th>
                        <td mat-cell *matCellDef="let row">{{ row.id }}</td>
                    </ng-container>

                    <!-- Title Column -->
                    <ng-container matColumnDef="title">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-left">Título</th>
                        <td
                            mat-cell
                            *matCellDef="let row"
                            [matTooltip]="row.title || ''"
                            matTooltipPosition="above"
                            matTooltipShowDelay="200"
                        >
                            {{ (row.title || '') | slice:0:25 }}{{ (row.title || '').length > 25 ? '...' : '' }}
                        </td>
                    </ng-container>

                    <!-- Service Column -->
                    <ng-container matColumnDef="service">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Serviço</th>
                        <td mat-cell *matCellDef="let row">{{ row.service }}</td>
                    </ng-container>

                    <!-- Severity Column -->
                    <ng-container matColumnDef="severity">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Severidade</th>
                        <td mat-cell *matCellDef="let row"><span [ngClass]="getSeverityClass(row.severity)" class="px-2 py-1 rounded text-xs font-semibold">{{ row.severity }}</span></td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                        <td mat-cell *matCellDef="let row"><span [ngClass]="getStatusClass(row.status)" class="px-2 py-1 rounded text-xs font-semibold">{{ row.status }}</span></td>
                    </ng-container>

                    <!-- Started At Column -->
                    <ng-container matColumnDef="startedAt">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Início</th>
                        <td mat-cell *matCellDef="let row">{{ row.startedAt | date: 'dd/MM/yyyy HH:mm' }}</td>
                    </ng-container>

                    <!-- Ended At Column -->
                    <ng-container matColumnDef="endedAt">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fim</th>
                        <td mat-cell *matCellDef="let row">
                            {{ row.endedAt ? (row.endedAt | date: 'dd/MM/yyyy HH:mm') : '-' }}
                        </td>
                    </ng-container>

                    <!-- MTTR Column -->
                    <ng-container matColumnDef="mttr">
                        <th mat-header-cell *matHeaderCellDef>MTTR</th>
                        <td mat-cell *matCellDef="let row"> {{ row.mttrMinutes ? row.mttrMinutes : ' - ' }} </td>
                    </ng-container>

                    <!-- Score Column -->
                    <ng-container matColumnDef="score">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Score</th>
                        <td mat-cell *matCellDef="let row">
                            {{ row.completenessScore !== undefined && row.completenessScore !== null ? row.completenessScore : '-' }}
                        </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let row" class="text-right">
                            <button
                                type="button"
                                aria-label="Editar incidente"
                                class="btn-icon edit-icon"
                                (click)="editIncident(+row.id)"
                                [matTooltip]="'Editar incidente #' + row.id + '\nTítulo: ' + (row.title || '-') + '\nServiço: ' + (row.service || '-') + '\nSeveridade: ' + (row.severity || '-')"
                                matTooltipPosition="above"
                                matTooltipShowDelay="200">
                                <fa-icon [icon]="pencil" aria-hidden="true"></fa-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell text-center text-gray-500 dark:text-gray-400 py-8" [attr.colspan]="displayedColumns.length">Nenhum incidente encontrado.</td>
                    </tr>
                </table>

                <div class="mt-4">
                    <mat-paginator [pageSizeOptions]="[5,10,20]"></mat-paginator>
                </div>
            </div>

        </section>
    </div>
</div>

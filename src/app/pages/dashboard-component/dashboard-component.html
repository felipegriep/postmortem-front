<div class="dashboard-wrapper">
    <!-- Toolbar -->
    <mat-toolbar class="dashboard-toolbar bg-gray-900 dark:bg-gray-800 text-white">
        <div class="dashboard-toolbar__content">
            <span class="dashboard-toolbar__title">Postmortem — Dashboard</span>
            <button
                mat-flat-button
                color="primary"
                class="incident-primary-button dashboard-toolbar__cta"
                routerLink="/incidents"
                type="button">
                Ver incidentes
            </button>
        </div>
    </mat-toolbar>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 md:p-8">
        
        <!-- Filtros -->
        <mat-card class="mb-6 filter-card bg-white dark:bg-gray-800">
            <mat-card-header>
                <mat-card-title class="text-white">Filtros</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="grid md:grid-cols-4 gap-4 mb-4">
                    <!-- Data inicial e final -->
                    <mat-form-field appearance="fill" class="filter-field period-field">
                        <mat-label>Período</mat-label>
                        <mat-date-range-input [rangePicker]="picker">
                            <input matStartDate placeholder="DD/MM/YYYY" [(ngModel)]="filters.startDate" name="startDate">
                            <input matEndDate placeholder="DD/MM/YYYY" [(ngModel)]="filters.endDate" name="endDate">
                        </mat-date-range-input>
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-date-range-picker #picker></mat-date-range-picker>
                    </mat-form-field>

                    <!-- Campo de data -->
                    <mat-form-field appearance="fill" class="filter-field date-field">
                        <mat-label>Campo de Data</mat-label>
                        <mat-select [(ngModel)]="filters.dateField" name="dateField">
                            <mat-option value="STARTED">Início</mat-option>
                            <mat-option value="ENDED">Fim</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Severidades -->
                    <mat-form-field appearance="fill" class="filter-field severity-field">
                        <mat-label>Severidade</mat-label>
                        <mat-select [(ngModel)]="filters.severities" name="severities" multiple>
                            <mat-option *ngFor="let severity of severityOptions" [value]="severity.value">
                                {{ severity.label }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Status -->
                    <mat-form-field appearance="fill" class="filter-field status-field">
                        <mat-label>Status</mat-label>
                        <mat-select [(ngModel)]="filters.statuses" name="statuses" multiple>
                            <mat-option *ngFor="let status of statusOptions" [value]="status.value">
                                {{ status.label }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- Toggle e botões -->
                <div class="flex items-center justify-between">
                    <mat-checkbox class="filter-checkbox" [(ngModel)]="filters.includeOpenInMttr" name="includeOpenInMttr">
                        Incluir abertos no MTTR
                    </mat-checkbox>
                    
                    <div class="space-x-2">
                        <button mat-flat-button color="primary" class="incident-primary-button" (click)="applyFilters()" type="button">
                            Aplicar
                        </button>
                        <button mat-stroked-button class="dashboard-clear-button" (click)="clearFilters()" type="button">
                            Limpar filtros
                        </button>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- KPI Cards -->
        <div class="grid md:grid-cols-4 gap-4 mb-6" *ngIf="summaryData">
            <!-- Incidentes -->
            <mat-card class="kpi-card" matTooltip="Total de incidentes no período (A = aberto, F = fechado)." matTooltipPosition="above">
                <mat-card-content>
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-700">Incidentes</h3>
                        <div class="text-3xl font-bold text-blue-600 mt-2">{{ summaryData.incidents.total }}</div>
                        <div class="text-sm text-gray-500 mt-1">
                            Abertos: {{ summaryData.incidents.open }} | Fechados: {{ summaryData.incidents.closed }}
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- MTTA médio -->
            <mat-card class="kpi-card" matTooltip="Tempo médio até reconhecimento (MTTA), ou seja, quando o incidente é identificado e confirmado pela equipe. p50 = mediana (metade dos casos fica abaixo desse valor)." matTooltipPosition="above">
                <mat-card-content>
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-700">MTTA médio</h3>
                        <div class="text-3xl font-bold text-green-600 mt-2">
                            {{ summaryData.time.mtta.avgMin || '-' }} min
                        </div>
                        <div class="text-sm text-gray-500 mt-1">
                            p50: {{ summaryData.time.mtta.p50Min || '-' }}
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- MTTR médio -->
            <mat-card class="kpi-card" matTooltip="Tempo médio até resolução (MTTR). p50 = mediana, indicando que metade dos incidentes fecha abaixo desse tempo." matTooltipPosition="above">
                <mat-card-content>
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-700">MTTR médio</h3>
                        <div class="text-3xl font-bold text-orange-600 mt-2">
                            {{ summaryData.time.mttr.avgMin || '-' }} min
                        </div>
                        <div class="text-sm text-gray-500 mt-1">
                            p50: {{ summaryData.time.mttr.p50Min || '-' }}
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Score médio -->
            <mat-card class="kpi-card" matTooltip="Score médio e cobertura dos checklists. p50 = mediana do score." matTooltipPosition="above">
                <mat-card-content>
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-700">Score médio</h3>
                        <div class="text-3xl font-bold text-purple-600 mt-2">
                            {{ summaryData.score.avg || '-' }}/100
                        </div>
                        <div class="text-sm text-gray-500 mt-1">
                            5 Porquês: {{ (summaryData.score.checksCoveragePct.fiveWhys || 0) | number:'1.0-0' }}%
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>

        <!-- Charts -->
        <div class="grid md:grid-cols-2 gap-6" *ngIf="seriesData">
            <!-- Série MTTA / MTTR -->
            <mat-card class="chart-card">
                <mat-card-header>
                    <mat-card-title>Série — MTTA / MTTR (min)</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="chart-container">
                        <div 
                            *ngIf="chartKey"
                            echarts 
                            [options]="timeChartOption" 
                            [autoResize]="true"
                            class="chart-echarts">
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Série Score / On-time -->
            <mat-card class="chart-card">
                <mat-card-header>
                    <mat-card-title>Série — Score médio / On-time ações (%)</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="chart-container">
                        <div 
                            *ngIf="chartKey"
                            echarts 
                            [options]="qualityChartOption" 
                            [autoResize]="true"
                            class="chart-echarts">
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>

        <!-- Error Message -->
        <div *ngIf="errorMessage" class="text-center text-red-600 py-8">
            <mat-icon class="mr-2">error</mat-icon>
            {{ errorMessage }}
        </div>

    </div>
</div>
